{% set stats = h.get_site_statistics() %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


<div class="stats-wrapper" id="stats-section">
  <h2 class="stats-title text-center mb-4" data-aos="fade-up"> 
    <i class="fas fa-chart-bar"></i> Satu Data ORAS
  </h2>

  <div class="stats-grid">

    <!-- Dataset Card -->
    <a href="{{ h.url_for('dataset.search') }}" class="stat-card dataset" 
       data-aos="zoom-in" data-aos-delay="0">
      <img src="/base/images/dataset.png" alt="Dataset Icon" class="icon" style="width:130px; height:130px;" />
      <div class="stat-number" data-count="{{ stats.dataset_count }}">0</div>
      <div class="stat-label">
        {{ _('Dataset Tersedia') if stats.dataset_count == 1 else _('Dataset Tersedia') }}
      </div>
    </a>

    {# --- Ambil angka OPD & Desa dari helper (isi sebelumnya milikmu) --- #}
    {% set stats = h.get_site_statistics() or {} %}
    {% set orgc = h.ckanet_org_counts('desa', 5000) %}
    {% set opd_count = orgc.non_desa %}
    {% set desa_count = orgc.desa %}

    <!-- OPD -->
    <a href="{{ h.url_for('organization.index') }}" class="stat-card organization"
       data-aos="zoom-in" data-aos-delay="100">
      <img src="/base/images/opd.png" alt="OPD Icon" class="icon" style="width:130px; height:130px;" />
      <div class="stat-number" data-count="{{ opd_count }}">0</div>
      <div class="stat-label">OPD Terhubung</div>
    </a>

    <!-- Desa -->
    <a href="{{ h.url_for('organization.index') ~ '?q=Desa' }}" class="stat-card desaku"
       data-aos="zoom-in" data-aos-delay="200">
      <img src="/base/images/desa.png" alt="Desa Icon" class="icon" style="width:130px; height:130px;" />
      <div class="stat-number" data-count="{{ desa_count }}">0</div>
      <div class="stat-label">Desa Terhubung</div>
    </a>

    <!-- Kategori -->
    <a href="{{ h.url_for('group.index') }}" class="stat-card category"
       data-aos="zoom-in" data-aos-delay="300">
      <img src="/base/images/kategori.png" alt="Kategori Icon" class="icon" style="width:130px; height:130px;" />
      <div class="stat-number" data-count="{{ stats.group_count }}">0</div>
      <div class="stat-label">
        {{ _('Kategori') if stats.group_count == 1 else _('Kategori') }}
      </div>
    </a>

  </div>
</div>

<style>
  .stats-wrapper { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:20vh; text-align:center; }
  .stats-title { font-size:2.2rem; font-weight:700; margin-bottom:10px; color:#333; }
  .stats-grid { display:flex; flex-direction:row; justify-content:center; align-items:stretch; gap:20px; flex-wrap:nowrap; }
  .stat-card { display:flex; flex-direction:column; align-items:center; justify-content:center; width:220px; height:230px; padding:25px; border-radius:15px; color:#fff; text-decoration:none; transition:transform .3s, box-shadow .3s, background .3s; box-shadow:0 6px 12px rgba(0,0,0,.15); }
  .stat-card:hover { transform:translateY(-8px); box-shadow:0 12px 20px rgba(0,0,0,.25); }
  .dataset { background:linear-gradient(135deg, #3498db, #2980b9); }
  .organization { background:linear-gradient(135deg, #2ecc71, #27ae60); }
  .category { background:linear-gradient(135deg, #f1c40f, #f39c12); }
  .desaku { background:linear-gradient(135deg, #0ff147, #19f312); }
  .stat-card .icon { font-size:8rem; margin-bottom:15px; text-shadow:2px 2px 4px rgba(0,0,0,.3); }
  .stat-card .stat-number { font-size:2rem; font-weight:700; margin-bottom:8px; }
  .stat-card .stat-label { font-size:1.3rem; font-weight:600; }
  @media (max-width: 992px) { .stats-grid { flex-wrap:wrap; } .stat-card { flex:1 1 45%; max-width:45%; margin-bottom:20px; } }
  @media (max-width: 576px) { .stat-card { flex:1 1 100%; max-width:100%; } .stat-card .icon { font-size:3rem; } .stat-card .stat-number { font-size:1.8rem; } .stat-card .stat-label { font-size:1.2rem; } .stats-title { font-size:1.8rem; } }
  @media (max-width: 768px) { .stat-card { flex:1 1 100%; max-width:100%; } }
</style>


<script>
(function () {
  // Animasi angka yang halus + bisa diulang
  function countTo(el, end, duration) {
    end = parseInt(end, 10) || 0;
    // Bersihkan animasi sebelumnya
    if (el._raf) cancelAnimationFrame(el._raf);

    // Kalau target 0, langsung tampilkan 0
    if (end === 0) { el.textContent = '0'; el._raf = null; return; }

    var startTime = null;
    el.textContent = '0';

    function step(ts) {
      if (!startTime) startTime = ts;
      var p = Math.min(1, (ts - startTime) / (duration || 1200));
      // easeOutCubic
      var eased = 1 - Math.pow(1 - p, 3);
      var val = Math.floor(eased * end);
      el.textContent = val.toLocaleString();
      if (p < 1) {
        el._raf = requestAnimationFrame(step);
      } else {
        el._raf = null;
      }
    }
    el._raf = requestAnimationFrame(step);
  }

  function resetNumber(el) {
    if (!el) return;
    if (el._raf) cancelAnimationFrame(el._raf);
    el.textContent = '0';
    el._raf = null;
  }

  function onEnter(card) {
    var num = card.querySelector('.stat-number');
    if (!num) return;
    countTo(num, num.getAttribute('data-count'), 1200);
  }

  function onExit(card) {
    var num = card.querySelector('.stat-number');
    if (!num) return;
    resetNumber(num);
  }

  function visibleNow(card) {
    var rect = card.getBoundingClientRect();
    var vh = window.innerHeight || document.documentElement.clientHeight;
    return rect.top < vh * 0.9 && rect.bottom > vh * 0.1;
  }

  function setupCounters() {
    var cards = Array.prototype.slice.call(document.querySelectorAll('.stats-wrapper .stat-card'));
    if (!cards.length) return;

    if ('IntersectionObserver' in window) {
      var io = new IntersectionObserver(function (entries) {
        entries.forEach(function (ent) {
          if (ent.isIntersecting) onEnter(ent.target);
          else onExit(ent.target);
        });
      }, { threshold: 0.35, rootMargin: '0px 0px -10% 0px' });

      cards.forEach(function (c) { io.observe(c); });

      // Kickstart: kalau sudah kelihatan sebelum observer attach
      setTimeout(function () {
        cards.forEach(function (c) { if (visibleNow(c)) onEnter(c); });
      }, 50);
    } else {
      // Fallback tanpa IO: animate saat load & tiap scroll/resize sederhana
      function tickAll() { cards.forEach(function (c) { if (visibleNow(c)) onEnter(c); else onExit(c); }); }
      tickAll();
      window.addEventListener('scroll', tickAll, { passive: true });
      window.addEventListener('resize', tickAll);
    }
  }

  // Jalankan saat DOM siap
  if (document.readyState !== 'loading') setupCounters();
  else document.addEventListener('DOMContentLoaded', setupCounters);
})();
</script>

