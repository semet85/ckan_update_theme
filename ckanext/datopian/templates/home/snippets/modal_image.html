{# templates/home/snippets/modal_image.html #}
{% set _id   = modal_id or 'promoImageModal' %}
{% set _img  = image_url or '/base/images/popup.jpg' %}
{% set _alt  = alt or 'Promosi' %}

<div id="{{ _id }}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="{{ _id }}Label">
  <div class="modal-dialog modal-lg" role="document" style="margin-top:40px;">
    <div class="modal-content" style="border-radius:10px; overflow:hidden; border:0;">
      <button type="button" class="close" data-dismiss="modal" aria-label="{{ _('Tutup') }}"
              style="position:absolute; right:10px; top:8px; z-index:2;">
        <span aria-hidden="true">&times;</span>
      </button>
      <img id="{{ _id }}__img" src="{{ _img }}" alt="{{ _alt }}" class="img-responsive"
           style="display:block; width:100%; height:auto; cursor:pointer;">
    </div>
  </div>
</div>

<script>
(function(){
  function onReady(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  onReady(function(){
    var modalId = '{{ _id }}';
    var homeURL = "{{ h.url_for('home.index') }}";
    var el = document.getElementById(modalId);
    var img = document.getElementById(modalId + '__img');

    function goHome(){
      window.location.href = homeURL;
    }

    // Pastikan Bootstrap modal tersedia (CKAN 2.9 pakai Bootstrap 3)
    if (el && typeof jQuery !== 'undefined' && jQuery.fn.modal) {
      var $el = jQuery(el);

      // Tampilkan modal setiap load. backdrop 'static' agar klik tidak menutup modal terlebih dulu
      $el.modal({backdrop:'static', keyboard:false, show:true});

      // Saat modal ditampilkan, pasang listener global
      $el.on('shown.bs.modal', function(){
        // Klik di mana saja pada dokumen -> redirect
        document.addEventListener('click', goHome, {once:true, capture:true});
        // Sentuh layar (mobile) -> redirect
        document.addEventListener('touchstart', goHome, {once:true, capture:true});
        // Tekan tombol apa pun -> redirect
        document.addEventListener('keydown', goHome, {once:true, capture:true});
        // Klik pada gambar (ekspisit)
        if (img) img.addEventListener('click', goHome, {once:true});
      });

      // Jika modal “disembunyikan” (jarang terjadi, karena kita redirect dulu), bersihkan listener
      $el.on('hidden.bs.modal', function(){
        document.removeEventListener('click', goHome, true);
        document.removeEventListener('touchstart', goHome, true);
        document.removeEventListener('keydown', goHome, true);
        if (img) img.removeEventListener('click', goHome, true);
      });
    }
  });
})();
</script>
