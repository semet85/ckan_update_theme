{# templates/home/snippets/modal_image.html #}
{% set _id   = modal_id or 'promoImageModal' %}
{% set _img  = image_url or '/base/images/popup.jpg' %}
{% set _alt  = alt or 'Promosi' %}

<div id="{{ _id }}" class="modal fade" tabindex="-1" role="dialog"
     data-backdrop="static" data-keyboard="false" aria-labelledby="{{ _id }}Label">
  <div class="modal-dialog modal-lg" role="document" style="margin-top:40px;">
    <div class="modal-content" style="border-radius:10px; overflow:hidden; border:0;">
      <button type="button" class="close" data-dismiss="modal" aria-label="{{ _('Tutup') }}"
              style="position:absolute; right:10px; top:8px; z-index:2;">
        <span aria-hidden="true">&times;</span>
      </button>
      <img id="{{ _id }}__img" src="{{ _img }}" alt="{{ _alt }}" class="img-responsive"
           style="display:block; width:100%; height:auto; cursor:pointer;">
    </div>
  </div>
</div>

<script>
(function(){
  var modalId = '{{ _id }}';
  var homeURL = "{{ h.url_for('home.index') }}";
  var $ = window.jQuery || window.$;

  function goHome(e){
    // cegah Bootstrap menutup modal dulu — langsung redirect
    if (e && typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    window.location.href = homeURL;
  }

  function bindGlobalHandlers(){
    // Tangkap SEMUA interaksi lebih awal (capturing) agar tidak “ditelan”
    window.addEventListener('click',      goHome, {once:true, capture:true});
    window.addEventListener('touchstart', goHome, {once:true, capture:true});
    window.addEventListener('keydown',    goHome, {once:true, capture:true});

    // Jaga-jaga: klik spesifik pada modal & gambar
    var modalEl = document.getElementById(modalId);
    var imgEl   = document.getElementById(modalId + '__img');
    if (modalEl) modalEl.addEventListener('click', goHome, {once:true, capture:true});
    if (imgEl)   imgEl.addEventListener('click',   goHome, {once:true});
  }

  function showModal(){
    bindGlobalHandlers();
    // Tampilkan modal setelah handler sudah aktif
    if ($ && $.fn && $.fn.modal) {
      $('#' + modalId).modal({backdrop:'static', keyboard:false}).modal('show');
    } else {
      // fallback kalau bootstrap tidak tersedia (hampir pasti ada di CKAN 2.9)
      var el = document.getElementById(modalId);
      if (el) { el.style.display = 'block'; el.style.opacity = 1; el.style.zIndex = 9999; }
    }
  }

  if (document.readyState !== 'loading') showModal();
  else document.addEventListener('DOMContentLoaded', showModal);
})();
</script>
